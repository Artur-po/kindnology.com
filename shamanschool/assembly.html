<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaman School ¬∑ Operating Theatre</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π */
        :root {
            --color-dark: #0a1519;
            --color-gold: #ffd966;
            --color-text: #e0f0e8;
        }
        body {
            background: linear-gradient(145deg, #0a1519 0%, #1a2c2a 100%);
            color: var(--color-text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        nav ul {
            display: flex;
            gap: 2rem;
            list-style: none;
            padding: 1rem 0;
            border-bottom: 1px solid #3a5e50;
        }
        nav a {
            color: #a0d5c0;
            text-decoration: none;
            font-weight: 500;
        }
        nav a.active {
            color: var(--color-gold);
            border-bottom: 2px solid var(--color-gold);
        }
        h1 {
            font-size: 2.5rem;
            color: var(--color-gold);
            margin: 2rem 0;
        }
        .theatre {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
        }
        /* –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ */
        .cooler {
            background: rgba(0, 30, 0, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid var(--color-gold);
            border-radius: 32px;
            padding: 1.5rem;
            height: fit-content;
        }
        .cooler h2 {
            color: var(--color-gold);
            margin-bottom: 1rem;
        }
        .filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .filters select, .filters input {
            background: rgba(255,255,255,0.1);
            border: 1px solid #3a5e50;
            color: white;
            padding: 0.5rem;
            border-radius: 20px;
        }
        .organs-grid {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 600px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        .organ-card {
            background: #1a332e;
            border: 1px solid #3a5e50;
            border-radius: 16px;
            padding: 0.8rem;
            cursor: grab;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .organ-card:hover {
            border-color: var(--color-gold);
            background: #1f4038;
        }
        .organ-card.dragging {
            opacity: 0.5;
        }
        .organ-type {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        .type-brain { background: #8b5cf6; }
        .type-eyes { background: #10b981; }
        .type-heart { background: #ef4444; }
        .type-hands { background: #f59e0b; }
        .type-reflexes { background: #3b82f6; }
        .quality {
            color: var(--color-gold);
            font-weight: bold;
        }
        /* –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è */
        .assembly {
            background: rgba(0, 30, 0, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid var(--color-gold);
            border-radius: 32px;
            padding: 1.5rem;
        }
        .slots {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 2rem 0;
        }
        .slot-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: #1a332e;
            border-radius: 40px;
            padding: 0.8rem 1.2rem;
            border: 1px solid #3a5e50;
        }
        .slot-label {
            width: 80px;
            font-weight: bold;
            color: var(--color-gold);
        }
        .slot-content {
            flex: 1;
            min-height: 40px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .slot-item {
            background: #2d4a40;
            border-radius: 20px;
            padding: 0.2rem 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        .slot-item .remove {
            color: #ff6b6b;
            cursor: pointer;
            font-weight: bold;
        }
        .add-slot-btn {
            background: transparent;
            border: 1px dashed var(--color-gold);
            color: var(--color-gold);
            padding: 0.5rem 1rem;
            border-radius: 40px;
            cursor: pointer;
            margin-top: 0.5rem;
        }
        .compatibility {
            background: #1a332e;
            border-radius: 20px;
            padding: 1rem;
            margin: 1.5rem 0;
            border-left: 4px solid var(--color-gold);
        }
        .compatibility .score {
            font-size: 2rem;
            font-weight: bold;
            color: var(--color-gold);
        }
        .save-bot {
            background: #6ec3a0;
            color: #0a1519;
            border: none;
            padding: 1rem 2rem;
            border-radius: 60px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            font-size: 1.2rem;
        }
        .saved-bots {
            margin-top: 2rem;
        }
        .bot-card {
            background: #1a332e;
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/archaeology/">Archaeology</a></li>
                <li><a href="/garden/">Satoshi Garden</a></li>
                <li><a href="/shamanschool/" class="active">Shaman School</a></li>
                <li><a href="/shamanschool/assembly.html" class="active">‚ö° Operating Theatre</a></li>
            </ul>
        </nav>

        <h1>‚ö° Operating Theatre ¬∑ KEV‚Äëbot Assembly</h1>

        <div class="theatre">
            <!-- –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ -->
            <div class="cooler">
                <h2>üßä Cooler</h2>
                <div class="filters">
                    <select id="typeFilter">
                        <option value="">All types</option>
                        <option value="brain">üß† Brain</option>
                        <option value="eyes">üëÅÔ∏è Eyes</option>
                        <option value="heart">‚ù§Ô∏è Heart</option>
                        <option value="hands">‚úã Hands</option>
                        <option value="reflexes">‚ö° Reflexes</option>
                    </select>
                    <input type="number" id="minQuality" placeholder="Min quality" value="80" min="0" max="100">
                    <input type="text" id="donorFilter" placeholder="Donor address (starts with)">
                </div>
                <div class="organs-grid" id="organsGrid"></div>
            </div>

            <!-- –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è -->
            <div class="assembly">
                <h2>üõ†Ô∏è Assembly</h2>
                <div class="slots" id="slotsContainer">
                    <!-- –°–ª–æ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <button class="add-slot-btn" id="addSlotBtn">‚ûï Add organ slot</button>

                <div class="compatibility" id="compatibilityBox">
                    <div>Compatibility: <span class="score" id="compatScore">0%</span></div>
                    <div id="compatDetails"></div>
                </div>

                <button class="save-bot" id="saveBotBtn">üíæ Save KEV‚Äëbot</button>

                <div class="saved-bots" id="savedBots">
                    <h3>üì¶ Your creations</h3>
                    <div id="botsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ
            let allOrgans = [];
            let selectedOrgans = []; // –º–∞—Å—Å–∏–≤ { slotIndex, organ } –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–Ω—è—Ç–æ–≥–æ —Å–ª–æ—Ç–∞
            let nextSlotId = 0;

            // –≠–ª–µ–º–µ–Ω—Ç—ã
            const organsGrid = document.getElementById('organsGrid');
            const slotsContainer = document.getElementById('slotsContainer');
            const compatScoreSpan = document.getElementById('compatScore');
            const compatDetails = document.getElementById('compatDetails');
            const botsList = document.getElementById('botsList');

            // –ó–∞–≥—Ä—É–∑–∫–∞ cooler.json
            async function loadCooler() {
                try {
                    const response = await fetch('/cooler.json');
                    const data = await response.json();
                    allOrgans = data.organs || [];
                    renderOrgans();
                } catch (e) {
                    organsGrid.innerHTML = '<p>Error loading cooler.json. Make sure it exists in the root.</p>';
                }
            }

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ—Ä–≥–∞–Ω–æ–≤
            function getFilteredOrgans() {
                const type = document.getElementById('typeFilter').value;
                const minQ = parseInt(document.getElementById('minQuality').value) || 0;
                const donor = document.getElementById('donorFilter').value.toLowerCase();
                return allOrgans.filter(o => {
                    if (type && o.type !== type) return false;
                    if (o.quality < minQ) return false;
                    if (donor && !o.donor.toLowerCase().startsWith(donor)) return false;
                    return true;
                });
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞
            function renderOrgans() {
                const filtered = getFilteredOrgans();
                organsGrid.innerHTML = filtered.map(organ => `
                    <div class="organ-card" draggable="true" data-organ='${JSON.stringify(organ).replace(/'/g, "&apos;")}'>
                        <span class="organ-type type-${organ.type}">${organ.type}</span>
                        <span class="quality">${organ.quality}</span>
                        <span>${organ.donor.slice(0,8)}‚Ä¶</span>
                        ${organ.strategy ? `<br><small>${organ.strategy}</small>` : ''}
                        ${organ.profit ? `<br><small>üí∞ ${organ.profit.toFixed(3)} ETH</small>` : ''}
                        ${organ.block ? `<br><small>#${organ.block}</small>` : ''}
                    </div>
                `).join('');

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag
                document.querySelectorAll('.organ-card').forEach(card => {
                    card.addEventListener('dragstart', handleDragStart);
                    card.addEventListener('dragend', handleDragEnd);
                });
            }

            let draggedOrgan = null;
            function handleDragStart(e) {
                const card = e.target.closest('.organ-card');
                if (!card) return;
                const organStr = card.dataset.organ;
                if (organStr) {
                    draggedOrgan = JSON.parse(organStr.replace(/&apos;/g, "'"));
                    e.dataTransfer.setData('text/plain', 'organ');
                }
            }
            function handleDragEnd() {
                draggedOrgan = null;
            }

            // –°–ª–æ—Ç—ã: —Ä–∞–∑—Ä–µ—à–∞–µ–º drop
            function setupDropZones() {
                document.querySelectorAll('.slot-content').forEach(zone => {
                    zone.addEventListener('dragover', (e) => e.preventDefault());
                    zone.addEventListener('drop', handleDrop);
                });
            }

            function handleDrop(e) {
                e.preventDefault();
                if (!draggedOrgan) return;
                const slotContent = e.target.closest('.slot-content');
                if (!slotContent) return;
                const slotIndex = parseInt(slotContent.dataset.slotIndex);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ç–∏–ø –≤ —ç—Ç–æ–º —Å–ª–æ—Ç–µ? –ü–æ–∫–∞ –º–æ–∂–Ω–æ –º–Ω–æ–≥–æ, –ø–æ–∑–∂–µ –æ–≥—Ä–∞–Ω–∏—á–∏–º
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ä–≥–∞–Ω –≤ —Å–ª–æ—Ç
                addOrganToSlot(slotIndex, draggedOrgan);
            }

            function addOrganToSlot(slotIndex, organ) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ selectedOrgans
                selectedOrgans.push({ slotIndex, organ });
                renderSlots();
                updateCompatibility();
            }

            function removeOrganFromSlot(slotIndex, organId) {
                // –£–¥–∞–ª—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ä–≥–∞–Ω –∏–∑ —Å–ª–æ—Ç–∞ (–ø–æ –∫—Ä–∏—Å—Ç–∞–ª–ª—É? –ø–æ–∫–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É –≤ –º–∞—Å—Å–∏–≤–µ)
                // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —É–¥–∞–ª–∏–º –≤—Å–µ —Å —Ç–∞–∫–∏–º slotIndex –∏ –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏–º
                selectedOrgans = selectedOrgans.filter(item => item.slotIndex !== slotIndex || item.organ.crystal_id !== organId);
                renderSlots();
                updateCompatibility();
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ª–æ—Ç–æ–≤
            function renderSlots() {
                // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã —Å–ª–æ—Ç–æ–≤
                const slotIndices = [...new Set(selectedOrgans.map(item => item.slotIndex))];
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º
                slotIndices.sort((a,b) => a - b);
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å–ª–æ—Ç–æ–≤, —Å–æ–∑–¥–∞—ë–º –æ–¥–∏–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                if (slotIndices.length === 0) {
                    slotIndices.push(0);
                }

                let html = '';
                slotIndices.forEach(idx => {
                    const organsInSlot = selectedOrgans.filter(item => item.slotIndex === idx).map(item => item.organ);
                    html += `
                        <div class="slot-row">
                            <div class="slot-label">Slot ${idx+1}</div>
                            <div class="slot-content" data-slot-index="${idx}">
                                ${organsInSlot.map(organ => `
                                    <div class="slot-item">
                                        <span class="organ-type type-${organ.type}">${organ.type}</span>
                                        ${organ.donor.slice(0,6)}‚Ä¶ (${organ.quality})
                                        <span class="remove" data-slot="${idx}" data-crystal="${organ.crystal_id}">‚úñÔ∏è</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                slotsContainer.innerHTML = html;
                setupDropZones();

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
                document.querySelectorAll('.remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const slot = e.target.dataset.slot;
                        const crystal = e.target.dataset.crystal;
                        removeOrganFromSlot(parseInt(slot), crystal);
                    });
                });
            }

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–ª–æ—Ç–∞
            document.getElementById('addSlotBtn').addEventListener('click', () => {
                // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
                const maxIdx = selectedOrgans.length > 0 ? Math.max(...selectedOrgans.map(i => i.slotIndex)) : -1;
                const newIdx = maxIdx + 1;
                // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ—Ç (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º)
                renderSlots(); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —É—á—Ç—ë—Ç –Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç –æ—Ä–≥–∞–Ω–æ–≤
            });

            // –†–∞—Å—á—ë—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π)
            function updateCompatibility() {
                if (selectedOrgans.length === 0) {
                    compatScoreSpan.innerText = '0%';
                    compatDetails.innerText = 'No organs selected';
                    return;
                }

                let score = 100;
                const brains = selectedOrgans.filter(item => item.organ.type === 'brain').map(item => item.organ);
                const eyes = selectedOrgans.filter(item => item.organ.type === 'eyes').map(item => item.organ);
                const hearts = selectedOrgans.filter(item => item.organ.type === 'heart').map(item => item.organ);
                const hands = selectedOrgans.filter(item => item.organ.type === 'hands').map(item => item.organ);
                const reflexes = selectedOrgans.filter(item => item.organ.type === 'reflexes').map(item => item.organ);

                // –®—Ç—Ä–∞—Ñ –∑–∞ —Ä–∞–∑–Ω–æ—Ä–æ–¥–Ω—ã–µ –º–æ–∑–≥–∏
                if (brains.length > 1) {
                    const donors = new Set(brains.map(b => b.donor));
                    if (donors.size > 1) score -= 10 * (donors.size - 1);
                }
                // –ë–æ–Ω—É—Å –µ—Å–ª–∏ –≥–ª–∞–∑–∞ –∏ —Ä—É–∫–∏ –æ—Ç –æ–¥–Ω–æ–≥–æ –¥–æ–Ω–æ—Ä–∞
                if (eyes.length > 0 && hands.length > 0) {
                    if (eyes[0].donor === hands[0].donor) score += 5;
                }
                // –®—Ç—Ä–∞—Ñ, –µ—Å–ª–∏ –º–∞–ª–æ –≥–ª–∞–∑
                if (eyes.length === 0) score -= 20;
                // –®—Ç—Ä–∞—Ñ, –µ—Å–ª–∏ –º–∞–ª–æ —Ä–µ—Ñ–ª–µ–∫—Å–æ–≤
                if (reflexes.length === 0) score -= 15;

                // –ù–µ –Ω–∏–∂–µ 0
                score = Math.max(0, Math.min(100, score));

                compatScoreSpan.innerText = score + '%';
                let details = '';
                if (brains.length > 1) details += '‚ö†Ô∏è Multiple brains from different donors\n';
                if (eyes.length === 0) details += '‚ùå No eyes ‚Äì bot is blind\n';
                if (reflexes.length === 0) details += '‚ùå No reflexes ‚Äì bot is slow\n';
                compatDetails.innerText = details;
            }

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–æ—Ç–∞
            document.getElementById('saveBotBtn').addEventListener('click', () => {
                if (selectedOrgans.length === 0) {
                    alert('Add at least one organ!');
                    return;
                }
                const name = prompt('Name your KEV‚Äëbot:', 'My creation');
                if (!name) return;

                const bot = {
                    id: Date.now(),
                    name,
                    organs: selectedOrgans.map(item => item.organ),
                    compatibility: parseInt(compatScoreSpan.innerText),
                    created: new Date().toISOString()
                };

                let saved = JSON.parse(localStorage.getItem('kev_bots') || '[]');
                saved.push(bot);
                localStorage.setItem('kev_bots', JSON.stringify(saved));
                renderSavedBots();
            });

            function renderSavedBots() {
                const saved = JSON.parse(localStorage.getItem('kev_bots') || '[]');
                if (saved.length === 0) {
                    botsList.innerHTML = '<p>No bots saved yet.</p>';
                    return;
                }
                botsList.innerHTML = saved.map(bot => `
                    <div class="bot-card">
                        <div>
                            <strong>${bot.name}</strong> ¬∑ ${bot.organs.length} organs ¬∑ compat ${bot.compatibility}%
                        </div>
                        <button onclick="deleteBot(${bot.id})">‚úñÔ∏è</button>
                    </div>
                `).join('');
            }

            window.deleteBot = function(id) {
                let saved = JSON.parse(localStorage.getItem('kev_bots') || '[]');
                saved = saved.filter(b => b.id !== id);
                localStorage.setItem('kev_bots', JSON.stringify(saved));
                renderSavedBots();
            };

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            loadCooler();
            renderSlots();
            renderSavedBots();

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            document.getElementById('typeFilter').addEventListener('change', renderOrgans);
            document.getElementById('minQuality').addEventListener('input', renderOrgans);
            document.getElementById('donorFilter').addEventListener('input', renderOrgans);
        })();
    </script>
</body>
</html>
