<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEV Surgical Theater ¬∑ Kindnology</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: #0f1a1c;
            color: #e0f0e8;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 2rem;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            font-size: 2.5rem;
            color: #ffd966;
            margin-bottom: 0.5rem;
        }
        .sub {
            color: #a0d5c0;
            margin-bottom: 2rem;
            font-style: italic;
        }
        .layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .cooler {
            background: #1a332e;
            border-radius: 32px;
            padding: 1.5rem;
            border: 1px solid #3a5e50;
            height: 80vh;
            overflow-y: auto;
        }
        .cooler h2 {
            color: #ffd966;
            margin-bottom: 1rem;
        }
        .filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }
        .filters button {
            background: #2a4540;
            border: 1px solid #3a5e50;
            color: #e0f0e8;
            padding: 0.4rem 1rem;
            border-radius: 40px;
            cursor: pointer;
            transition: 0.2s;
        }
        .filters button.active {
            background: #6ec3a0;
            color: #0a1519;
            border-color: #6ec3a0;
        }
        .organ-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        .organ-card {
            background: #1f4038;
            border-radius: 20px;
            padding: 1rem;
            border-left: 4px solid;
            cursor: grab;
            transition: 0.2s;
            user-select: none;
        }
        .organ-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .organ-card.brain { border-left-color: #ffb347; }
        .organ-card.eyes { border-left-color: #5bc0de; }
        .organ-card.heart { border-left-color: #d9534f; }
        .organ-card.hands { border-left-color: #5cb85c; }
        .organ-card.reflexes { border-left-color: #f0ad4e; }
        .organ-type {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #aaa;
        }
        .organ-donor {
            font-family: monospace;
            font-size: 0.8rem;
            color: #ffd966;
            margin: 0.3rem 0;
        }
        .organ-quality {
            font-weight: bold;
            color: #6ec3a0;
        }
        .workspace {
            background: #1a332e;
            border-radius: 32px;
            padding: 1.5rem;
            border: 1px solid #3a5e50;
            height: 80vh;
            overflow-y: auto;
        }
        .slot-container {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin: 1.5rem 0;
        }
        .slot-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #0e2622;
            padding: 0.5rem 1rem;
            border-radius: 60px;
        }
        .slot-label {
            width: 70px;
            color: #ffd966;
        }
        .slot-content {
            flex: 1;
            background: #1a332e;
            padding: 0.3rem 1rem;
            border-radius: 40px;
            border: 1px dashed #3a5e50;
            min-height: 2.5rem;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        .slot-remove {
            background: none;
            border: none;
            color: #d9534f;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .add-slot-btn {
            background: #2a4540;
            border: 1px solid #3a5e50;
            color: #e0f0e8;
            padding: 0.5rem 1rem;
            border-radius: 40px;
            cursor: pointer;
            margin-top: 0.5rem;
        }
        .compatibility-bar {
            background: #0e2622;
            border-radius: 40px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .compatibility-fill {
            height: 10px;
            background: #6ec3a0;
            border-radius: 40px;
            width: 0%;
            transition: width 0.3s;
        }
        .btn-primary {
            background: #6ec3a0;
            border: none;
            color: #0a1519;
            padding: 0.8rem 2rem;
            border-radius: 60px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            font-size: 1.2rem;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #a0d5c0;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üß¨ –•–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è KEV</h1>
    <div class="sub">–°–æ–±–∏—Ä–∞–π –∑–∞—â–∏—Ç–Ω–∏–∫–æ–≤ –∏–∑ –æ—Ä–≥–∞–Ω–æ–≤ MEV-–∫–∏—Ç–æ–≤. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —Å–ª–æ—Ç—ã.</div>

    <div class="layout">
        <!-- –õ–µ–≤—ã–π –±–ª–æ–∫: —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ -->
        <div class="cooler" id="cooler">
            <h2>üßä –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –æ—Ä–≥–∞–Ω–æ–≤</h2>
            <div class="filters" id="filters">
                <button data-type="all" class="active">–í—Å–µ</button>
                <button data-type="brain">üß† –ú–æ–∑–≥–∏</button>
                <button data-type="eyes">üëÅÔ∏è –ì–ª–∞–∑–∞</button>
                <button data-type="heart">‚ù§Ô∏è –°–µ—Ä–¥—Ü–∞</button>
                <button data-type="hands">‚úã –†—É–∫–∏</button>
                <button data-type="reflexes">‚ö° –†–µ—Ñ–ª–µ–∫—Å—ã</button>
            </div>
            <div class="filters" style="margin-top: 0.5rem;">
                <label style="color:#a0d5c0;">–ú–∏–Ω. –∫–∞—á–µ—Å—Ç–≤–æ:</label>
                <input type="range" id="qualityRange" min="0" max="100" value="0" style="width:100px;">
                <span id="qualityValue">0</span>
                <input type="text" id="donorFilter" placeholder="–î–æ–Ω–æ—Ä (–∞–¥—Ä–µ—Å...)" style="background:#2a4540; border:1px solid #3a5e50; color:white; padding:0.3rem; border-radius:20px;">
            </div>
            <div id="organList" class="organ-grid">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ä–≥–∞–Ω–æ–≤...</div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤—ã–π –±–ª–æ–∫: –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è -->
        <div class="workspace" id="workspace">
            <h2>üõ†Ô∏è –°–±–æ—Ä–∫–∞ KEV-–±–æ—Ç–∞</h2>
            <div id="slotContainer" class="slot-container">
                <!-- –°–ª–æ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <button class="add-slot-btn" id="addSlotBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç</button>

            <div class="compatibility-bar">
                <div style="display: flex; justify-content: space-between; margin-bottom:0.3rem;">
                    <span>–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:</span>
                    <span id="compatibilityPercent">0%</span>
                </div>
                <div class="compatibility-fill" id="compatibilityFill" style="width:0%;"></div>
            </div>

            <div>
                <label>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:</label>
                <select id="specialization" style="background:#2a4540; color:white; border:1px solid #3a5e50; padding:0.5rem; border-radius:40px; width:100%; margin:0.5rem 0;">
                    <option value="SANDWICH_GUARDIAN">ü•™ SANDWICH_GUARDIAN</option>
                    <option value="ARBITRAGE_HUNTER">üí± ARBITRAGE_HUNTER</option>
                    <option value="LIQUIDITY_PROTECTOR">üíß LIQUIDITY_PROTECTOR</option>
                    <option value="MEMPOOL_CLEANER">üßπ MEMPOOL_CLEANER</option>
                </select>
            </div>

            <button class="btn-primary" id="saveBotBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å KEV-–±–æ—Ç–∞</button>
            <div style="margin-top:1rem;" id="savedBotsList">
                <h3>üì¶ –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –±–æ—Ç—ã</h3>
                <ul id="botsUl"></ul>
            </div>
        </div>
    </div>
</div>

<script>
    // ========== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ==========
    let allOrgans = [];
    let filteredOrgans = [];
    let slots = []; // –º–∞—Å—Å–∏–≤ –æ—Ä–≥–∞–Ω–æ–≤ –≤ —Å–ª–æ—Ç–∞—Ö (null –∏–ª–∏ –æ–±—ä–µ–∫—Ç –æ—Ä–≥–∞–Ω–∞)
    let currentFilter = 'all';
    let minQuality = 0;
    let donorFilter = '';

    // ========== –ó–∞–≥—Ä—É–∑–∫–∞ cooler.json ==========
    async function loadCooler() {
        try {
            const response = await fetch('/cooler.json');
            if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å cooler.json');
            const data = await response.json();
            allOrgans = data.organs || data; // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
            applyFilters();
        } catch (e) {
            document.getElementById('organList').innerHTML = `<div style="color:#d9534f;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
        }
    }

    // ========== –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ==========
    function applyFilters() {
        filteredOrgans = allOrgans.filter(organ => {
            if (currentFilter !== 'all' && organ.type !== currentFilter) return false;
            if (organ.quality < minQuality) return false;
            if (donorFilter && !organ.donor.toLowerCase().includes(donorFilter.toLowerCase())) return false;
            return true;
        });
        renderOrganList();
    }

    // ========== –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞ ==========
    function renderOrganList() {
        const container = document.getElementById('organList');
        if (filteredOrgans.length === 0) {
            container.innerHTML = '<div style="color:#aaa;">–ù–µ—Ç –æ—Ä–≥–∞–Ω–æ–≤ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É</div>';
            return;
        }
        let html = '';
        filteredOrgans.forEach(organ => {
            html += `
                <div class="organ-card ${organ.type}" draggable="true" data-organ='${JSON.stringify(organ).replace(/'/g, "&apos;")}'>
                    <div class="organ-type">${organ.type}</div>
                    <div class="organ-donor">${organ.donor.slice(0,8)}...${organ.donor.slice(-4)}</div>
                    <div class="organ-quality">‚ö° ${organ.quality}</div>
                    ${organ.strategy ? `<small>${organ.strategy}</small>` : ''}
                    ${organ.profit ? `<small>üí∞ ${organ.profit.toFixed(3)} ETH</small>` : ''}
                </div>
            `;
        });
        container.innerHTML = html;

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag
        document.querySelectorAll('.organ-card').forEach(card => {
            card.addEventListener('dragstart', handleDragStart);
        });
    }

    // ========== Drag & Drop ==========
    function handleDragStart(e) {
        const organStr = e.target.getAttribute('data-organ');
        e.dataTransfer.setData('text/plain', organStr);
        e.dataTransfer.effectAllowed = 'move';
    }

    // ========== –°–ª–æ—Ç—ã ==========
    function renderSlots() {
        const container = document.getElementById('slotContainer');
        let html = '';
        slots.forEach((organ, index) => {
            html += `
                <div class="slot-row" data-index="${index}">
                    <span class="slot-label">${organ ? organ.type : '–ø—É—Å—Ç–æ'}</span>
                    <div class="slot-content" data-slot="${index}">
                        ${organ ? `${organ.type} –æ—Ç ${organ.donor.slice(0,6)}... (–∫–∞—á.${organ.quality})` : '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –æ—Ä–≥–∞–Ω'}
                    </div>
                    <button class="slot-remove" data-index="${index}">‚úñÔ∏è</button>
                </div>
            `;
        });
        container.innerHTML = html;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drop –Ω–∞ —Å–ª–æ—Ç—ã
        document.querySelectorAll('.slot-content').forEach(div => {
            div.addEventListener('dragover', e => e.preventDefault());
            div.addEventListener('drop', handleDrop);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
        document.querySelectorAll('.slot-remove').forEach(btn => {
            btn.addEventListener('click', () => {
                const index = btn.getAttribute('data-index');
                slots[index] = null;
                renderSlots();
                updateCompatibility();
            });
        });
    }

    function handleDrop(e) {
        e.preventDefault();
        const organStr = e.dataTransfer.getData('text/plain');
        if (!organStr) return;
        const organ = JSON.parse(organStr);
        const slotDiv = e.target.closest('.slot-content');
        if (!slotDiv) return;
        const index = slotDiv.getAttribute('data-slot');
        if (index === undefined) return;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ —É–∂–µ —Å–ª–æ—Ç
        if (slots[index]) {
            alert('–≠—Ç–æ—Ç —Å–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç. –£–¥–∞–ª–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –æ—Ä–≥–∞–Ω, —á—Ç–æ–±—ã –∑–∞–º–µ–Ω–∏—Ç—å.');
            return;
        }

        slots[index] = organ;
        renderSlots();
        updateCompatibility();
    }

    // ========== –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å ==========
    function updateCompatibility() {
        const filled = slots.filter(o => o !== null);
        if (filled.length === 0) {
            document.getElementById('compatibilityPercent').innerText = '0%';
            document.getElementById('compatibilityFill').style.width = '0%';
            return;
        }

        let score = 100;
        // –®—Ç—Ä–∞—Ñ –∑–∞ —Ä–∞–∑–Ω—ã—Ö –¥–æ–Ω–æ—Ä–æ–≤ —Å—Ä–µ–¥–∏ –º–æ–∑–≥–æ–≤
        const brains = filled.filter(o => o.type === 'brain');
        if (brains.length > 1) {
            const donors = new Set(brains.map(b => b.donor));
            if (donors.size > 1) score -= 10 * (donors.size - 1);
        }
        // –®—Ç—Ä–∞—Ñ, –µ—Å–ª–∏ –≥–ª–∞–∑–∞ –∏ —Ä—É–∫–∏ –æ—Ç —Ä–∞–∑–Ω—ã—Ö –¥–æ–Ω–æ—Ä–æ–≤ (–ø–ª–æ—Ö–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è)
        const eyes = filled.find(o => o.type === 'eyes');
        const hands = filled.find(o => o.type === 'hands');
        if (eyes && hands && eyes.donor !== hands.donor) score -= 15;
        // –ë–æ–Ω—É—Å, –µ—Å–ª–∏ —Å–µ—Ä–¥—Ü–µ –æ—Ç —Ç–æ–≥–æ –∂–µ –¥–æ–Ω–æ—Ä–∞, —á—Ç–æ –∏ –º–æ–∑–≥
        const heart = filled.find(o => o.type === 'heart');
        const brain = filled.find(o => o.type === 'brain');
        if (heart && brain && heart.donor === brain.donor) score += 10;
        // –û–≥—Ä–∞–Ω–∏—á–∏–º
        score = Math.max(0, Math.min(100, score));

        document.getElementById('compatibilityPercent').innerText = score + '%';
        document.getElementById('compatibilityFill').style.width = score + '%';
    }

    // ========== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–ª–æ—Ç–∞ ==========
    document.getElementById('addSlotBtn').addEventListener('click', () => {
        slots.push(null);
        renderSlots();
    });

    // ========== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–æ—Ç–∞ ==========
    document.getElementById('saveBotBtn').addEventListener('click', () => {
        const filled = slots.filter(o => o !== null);
        if (filled.length === 0) {
            alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ—Ä–≥–∞–Ω –≤ —Å–ª–æ—Ç—ã!');
            return;
        }

        const specialization = document.getElementById('specialization').value;
        const compatibility = parseInt(document.getElementById('compatibilityPercent').innerText);
        const bot = {
            id: Date.now(),
            name: `KEV-–±–æ—Ç ${new Date().toLocaleString()}`,
            organs: slots.map(s => s ? { type: s.type, donor: s.donor, quality: s.quality } : null),
            compatibility,
            specialization,
            created: new Date().toISOString()
        };

        let bots = JSON.parse(localStorage.getItem('kev_bots') || '[]');
        bots.push(bot);
        localStorage.setItem('kev_bots', JSON.stringify(bots));
        renderSavedBots();
        alert('–ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ localStorage!');
    });

    // ========== –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤ ==========
    function renderSavedBots() {
        const bots = JSON.parse(localStorage.getItem('kev_bots') || '[]');
        const ul = document.getElementById('botsUl');
        ul.innerHTML = bots.map(bot => `<li>${bot.name} (—Å–æ–≤–º. ${bot.compatibility}%)</li>`).join('');
    }

    // ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ ==========
    document.getElementById('filters').addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON') {
            document.querySelectorAll('#filters button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            currentFilter = e.target.getAttribute('data-type');
            applyFilters();
        }
    });

    document.getElementById('qualityRange').addEventListener('input', e => {
        minQuality = parseInt(e.target.value);
        document.getElementById('qualityValue').innerText = minQuality;
        applyFilters();
    });

    document.getElementById('donorFilter').addEventListener('input', e => {
        donorFilter = e.target.value;
        applyFilters();
    });

    // ========== –°—Ç–∞—Ä—Ç ==========
    (async function() {
        await loadCooler();
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–æ—Ç–æ–≤ (–æ–¥–∏–Ω –ø—É—Å—Ç–æ–π —Å–ª–æ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        slots = [null];
        renderSlots();
        renderSavedBots();
    })();
</script>
</body>
</html>
